name: Integration Tests Against Released JAR

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  test:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'adopt'

      - name: Cache Maven packages
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Download JAR from Release
        run: |
          REPO="${{ github.repository }}"
          TAG="1.0.0"
          ASSET_NAME="internal-*.jar"

          RELEASE_ID=$(curl -s -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/releases/tags/$TAG" | jq -r '.id')

          if [ -z "$RELEASE_ID" ] || [ "$RELEASE_ID" = "null" ]; then
            echo "Release tag '$TAG' not found!"
            exit 1
          fi

          ASSET_URL=$(curl -s -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/releases/$RELEASE_ID/assets" | \
            jq -r ".[] | select(.name | test(\"$ASSET_NAME\")) | .browser_download_url" | head -1)

          if [ -z "$ASSET_URL" ] || [ "$ASSET_URL" = "null" ]; then
            echo "No asset matching '$ASSET_NAME' found in release '$TAG'"
            exit 1
          fi

          mkdir -p target
          curl -L -H "Accept: application/octet-stream" -o target/internal.jar "$ASSET_URL"

          ls -la target/internal.jar

          if [ ! -f target/internal.jar ]; then
            echo "Failed to download JAR"
            exit 1
          fi

          file target/internal.jar | grep -q "Java archive"
          echo "Successfully downloaded JAR: target/internal.jar"

      - name: Start internal application in background
        run: |
          jjava -Dsecret=qazWSXedc -Dmock=http://localhost:8888/ -jar internal-0.0.1-SNAPSHOT.jar &
          APP_PID=$!
          echo "Started internal application in background (PID: $APP_PID)"

          sleep 20

          curl -f http://localhost:8080/endpoint || (echo "Health endpoint not reachable" && exit 1)
          echo "Application is ready at http://localhost:8080/endpoint"

      - name: Run tests
        run: |
          mvn clean test

      - name: Generate Allure report
        run: |
          mvn allure:report

      - name: Upload Allure report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: target/site/allure-maven-plugin

      - name: Kill application
        run: |
          pkill -f "internal.jar" || echo "No application to kill"
